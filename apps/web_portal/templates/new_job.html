{% extends "base.html" %}

{% block head %}
<title>Apollo Fuel - Submit New Job</title>
<style>
  #spinner {
    background-color:rgba(0,0,0, 0.4);
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999;
  }
  
  .bd-placeholder-img {
    font-size: 1.125rem;
    text-anchor: middle;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }

  @media (min-width: 768px) {
    .bd-placeholder-img-lg {
      font-size: 3.5rem;
    }
  }

  .container {
    max-width: 960px;
  }

  .lh-condensed {
    line-height: 1.25;
  }
</style>
{% endblock %}

{% block container %}

<div class="card w-100">
  <div id="spinner" style="display:none;"><img src="https://www.baidu.com/aladdin/img/tools/loading.gif"/></div>
  <div class="card-body">
    <h4 class="card-title">Job Arguments</h4>

    <div class="row">
    <div class="col-md-8 order-md-1">
    <form class="needs-validation" novalidate>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="partner_id">Partner ID</label>
          <input type="text" class="form-control" id="partner_id" required>
          <div class="invalid-feedback">
            Partner ID is required. You can set it up with our BD team: idg-apollo@baidu.com
          </div>
        </div>
      </div>
  
      <hr class="mb-4">
      <div class="d-block my-3">
        <div class="custom-control custom-radio custom-control-inline">
          <input type="radio" id="bos" name="storage" class="custom-control-input" checked required>
          <label class="custom-control-label" for="bos">Baidu BOS</label>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="cc-name">Access Key</label>
          <input type="text" class="form-control" id="access_key" placeholder="" required>
          <div class="invalid-feedback">Access Key is required.</div>
        </div>
       <div class="col-md-6 mb-3">
          <label for="cc-number">Secret Key</label>
          <input type="password" class="form-control" id="secret_key" placeholder="" required>
          <div class="invalid-feedback">Secret Key is required.</div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="input_data_path">Input Data Path</label>
          <input type="text" class="form-control" id="input_data_path" placeholder="" required>
          <div class="invalid-feedback">Input Data Path is required for this job.</div>
        </div>

        {% if job_type == "VIRTUAL_LANE_GENERATION" or job_type == "SENSOR_CALIBRATION" or
        job_type == "OPEN_SPACE_PLANNER_PROFILING" or job_type == "PREDICTION_MODEL_TRAINING" %}
        <div class="col-md-6 mb-3">
          <label for="output_data_path">Output Data Path</label>
          <input type="text" class="form-control" id="output_data_path" placeholder="" required>
          <div class="invalid-feedback">Output Data Path is required for this job.</div>
        </div>
        {% endif %}
      </div>

      {% if job_type == "PREDICTION_MODEL_TRAINING" %}
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="map_name">Map Name</label>
          <input type="text" class="form-control" id="zone_id" placeholder="" required>
          <div class="invalid-feedback">Map name is required for this job.</div>
        </div>
      </div>
      {% endif %}

      {% if job_type == "VIRTUAL_LANE_GENERATION" %}
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="zone_id">Zone ID</label>
          <input type="text" class="form-control" id="zone_id" placeholder="" required>
          <div class="invalid-feedback">Zone is required for this job.</div>
        </div>
  
        <div class="col-md-6 mb-3">
          <label for="lidar_type">Lidar Type</label>
          <input type="text" class="form-control" id="lidar_type" placeholder="" required>
          <div class="invalid-feedback">Lidar type is required for this job.</div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="lane_width">Lane Width</label>
          <input type="text" class="form-control" id="lane_width" placeholder="" required>
          <div class="invalid-feedback">Lane Width is required for this job.</div>
        </div>
  
        <div class="col-md-6 mb-3">
          <label for="extra_roi_extension">Extra ROI Extension</label>
          <input type="text" class="form-control" id="extra_roi_extension" placeholder="" required>
          <div class="invalid-feedback">Extra roi extension is required for this job.</div>
        </div>
      </div>
      {% endif %}
  
      <hr class="mb-4">
      <button class="btn btn-primary btn-lg btn-block" type="submit">Submit Job</button>
    </form>
  </div>
</div>
</div>
{% endblock %}

{% block script %}
<script>
  // Example starter JavaScript for disabling form submissions if there are invalid fields
  job_type = "{{ job_type }}";
  jQuery(document).ready(function($) {
    'use strict'

    // Fetch all the forms we want to apply custom Bootstrap validation styles to
    var forms = document.getElementsByClassName('needs-validation');

    // Loop over them and prevent submission
    Array.prototype.filter.call(forms, function (form) {
      form.addEventListener('submit', function (event) {
        event.preventDefault();
        if (form.checkValidity() === false) {
          event.stopPropagation();
        } else {
          submitForm();
        }
        form.classList.add('was-validated');
      }, false)
    });
    
    function showSpinner() {
      var spinner = document.getElementById("spinner");
      spinner.style.display = "flex";
    }

    function hideSpinner() {
      var spinner = document.getElementById("spinner");
      spinner.style.display = "none";
    }

    function submitForm() {
      showSpinner();
      // Construct a dict following SaasJobArg.
      var job_arg = {
        "job_type": job_type,
        "partner": {
          "id": $("#partner_id").val(),
        },
        "flags": {
          "input_data_path": $("#input_data_path").val(),
        },
      };
      if (job_type === 'VIRTUAL_LANE_GENERATION' || job_type === 'SENSOR_CALIBRATION' ||
          job_type === 'OPEN_SPACE_PLANNER_PROFILING' || job_type == 'PREDICTION') {
        job_arg["flags"]["output_data_path"] = $("#output_data_path").val();
      }
      if (job_type == 'PREDICTION_MODEL_TRAINING') {
        job_arg["flags"]["map_name"] = $("#map_name").val();
      }
      if (job_type === 'VIRTUAL_LANE_GENERATION') {
        job_arg["flags"]["zone_id"] = $("#zone_id").val();
        job_arg["flags"]["lidar_type"] = $("#lidar_type").val();
        job_arg["flags"]["lane_width"] = $("#lane_width").val();
        job_arg["flags"]["extra_roi_extension"] = $("#extra_roi_extension").val();
      }
      if ($("#bos").is(':checked')) {
        job_arg["partner"]["bos"] = {
          "access_key": $("#access_key").val(),
          "secret_key": $("#secret_key").val(),
         };
      }
  
      $.ajax({
        type: "POST",
        url: "{{ url_for('submit_job') }}",
        data: JSON.stringify(job_arg),
        contentType: 'application/json;charset=UTF-8',
        success: function (response) {
          hideSpinner();
          alert("Your job has been accepted!");
          window.location = "{{ url_for('index') }}";
        },
        error: function (response) {
          hideSpinner();
          alert(response.statusText);
        },
      });
    }
  });
</script>
{% endblock %}
